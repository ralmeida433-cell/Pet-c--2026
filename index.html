<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>Hotel Pet CÁ - Sistema Moderno de Gerenciamento</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile.css">

    <meta name="description" content="Sistema moderno de gerenciamento para Hotel Pet CÁ - Aplicativo Multiplataforma">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="css/logo.png">
    <link rel="manifest" href="manifest.json">
</head>

<body>
    <div id="loading" class="loading-screen">
        <div class="loading-content">
            <div class="pet-logo-animated">
                <i class="fas fa-paw"></i>
            </div>
            <h2>Hotel Pet CÁ</h2>
            <p>Sistema Moderno de Gerenciamento</p>
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>

    <header class="mobile-header">
        <div class="mobile-header-left">
            <button class="header-menu-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <span class="mobile-header-title" id="mobile-page-title">Hotel Pet CÁ</span>
        </div>
        <div class="mobile-nav-controls">
            <button class="nav-btn" id="nav-back-btn" onclick="window.hotelPetApp.goBack()" disabled>
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="nav-btn" id="nav-forward-btn" onclick="window.hotelPetApp.goForward()" disabled>
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </header>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="css/logo.png" alt="Hotel Pet CÁ" class="logo-image-only"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="logo-fallback" style="display: none;">
                    <i class="fas fa-paw"></i>
                </div>
            </div>
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <ul class="sidebar-menu">
            <li class="menu-item active" data-section="overview">
                <a href="#" onclick="navigateToSection('overview')">
                    <i class="fas fa-eye"></i>
                    <span>Visão Geral</span>
                </a>
            </li>
            <li class="menu-item" data-section="dashboard">
                <a href="#" onclick="navigateToSection('dashboard')">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="menu-item" data-section="animals">
                <a href="#" onclick="navigateToSection('animals')">
                    <i class="fas fa-dog"></i>
                    <span>Animais</span>
                </a>
            </li>
            <li class="menu-item" data-section="reservations">
                <a href="#" onclick="navigateToSection('reservations')">
                    <i class="fas fa-calendar-check"></i>
                    <span>Reservas</span>
                </a>
            </li>
            <li class="menu-item" data-section="inventory">
                <a href="#" onclick="navigateToSection('inventory')">
                    <i class="fas fa-boxes"></i>
                    <span>Controle de Estoque</span>
                </a>
            </li>
            <li class="menu-item" data-section="reports">
                <a href="#" onclick="navigateToSection('reports')">
                    <i class="fas fa-chart-bar"></i>
                    <span>Relatórios</span>
                </a>
            </li>
        </ul>
    </nav>

    <div class="sidebar-overlay" onclick="closeSidebar()"></div>

    <main class="main-content">
        <div id="app" class="app-container hidden">
            <section id="overview" class="content-section active">
                <div class="page-header">
                    <div class="page-header-content">
                        <h1>Visão Geral</h1>
                        <p>Status em tempo real de todas as acomodações do Hotel Pet CÁ</p>
                    </div>
                </div>
                <div id="kennels-visualization" class="kennels-container"></div>
            </section>

            <section id="dashboard" class="content-section">
                <div class="page-header">
                    <div class="page-header-content">
                        <h1>Dashboard</h1>
                        <p>Visão geral completa do Hotel Pet CÁ</p>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-paw"></i></div>
                        <div class="stat-info"><h3 id="total-animals">0</h3><p>Animais Cadastrados</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-bed"></i></div>
                        <div class="stat-info"><h3 id="active-reservations">0</h3><p>Reservas Ativas</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-info"><h3 id="monthly-revenue">R$ 0,00</h3><p>Receita do Mês</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                        <div class="stat-info"><h3 id="occupancy-rate">0%</h3><p>Taxa de Ocupação</p></div>
                    </div>
                </div>
                <div class="charts-container">
                    <div class="chart-card"><h3>Reservas por Mês</h3><div class="chart-wrapper"><canvas id="monthlyChart"></canvas></div></div>
                    <div class="chart-card"><h3>Ocupação Atual</h3><div class="chart-wrapper"><canvas id="kennel-chart"></canvas></div></div>
                    <div class="chart-card"><h3>Receita por Pagamento</h3><div class="chart-wrapper"><canvas id="paymentChart"></canvas></div></div>
                </div>
                <div class="recent-reservations">
                    <h3>Reservas Recentes</h3>
                    <div class="table-container">
                        <table id="recent-reservations-table">
                            <thead>
                                <tr><th>Animal</th><th>Tutor</th><th>Check-in</th><th>Check-out</th><th>Valor</th><th>Status</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="animals" class="content-section">
                <div class="page-header">
                    <div class="page-header-content">
                        <h1>Gerenciamento de Animais</h1>
                        <p>Cadastro e controle de todos os pets</p>
                    </div>
                </div>
                <div class="filters-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="animal-search" placeholder="Buscar animais...">
                        <button class="voice-search-btn" onclick="startVoiceSearch('animal-search')"><i class="fas fa-microphone"></i></button>
                    </div>
                    <select id="kennel-filter">
                        <option value="">Todos</option>
                        <option value="CÃO">Cães</option>
                        <option value="GATO">Gatos</option>
                    </select>
                </div>
                <div class="table-container">
                    <table id="animals-table">
                        <thead>
                            <tr><th>Foto</th><th>Animal</th><th>Espécie</th><th>Tutor</th><th>Telefone</th><th>Ações</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section id="reservations" class="content-section">
                <div class="page-header">
                    <div class="page-header-content">
                        <h1>Gerenciamento de Reservas</h1>
                        <p>Controle completo de hospedagens</p>
                    </div>
                    <div class="page-header-actions">
                        <button class="btn btn-primary" id="add-reservation-btn"><i class="fas fa-plus"></i> Nova Reserva</button>
                    </div>
                </div>
                <div class="filters-container">
                    <div class="search-box"><i class="fas fa-search"></i><input type="text" id="reservation-search" placeholder="Buscar reservas..."></div>
                    <div class="quick-filters">
                        <div class="filter-pill active" data-status="">Todas</div>
                        <div class="filter-pill" data-status="ATIVA">Ativas</div>
                        <div class="filter-pill" data-status="FINALIZADA">Finalizadas</div>
                    </div>
                    <select id="status-filter">
                        <option value="">Todos Status</option>
                        <option value="ATIVA">Ativa</option>
                        <option value="FINALIZADA">Finalizada</option>
                    </select>
                    <input type="month" id="month-filter">
                </div>
                <div class="table-container">
                    <table id="reservations-table">
                        <thead>
                            <tr><th>Animal</th><th>Alojamento</th><th>Período</th><th>Diárias</th><th>Valor</th><th>Status</th><th>Ações</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section id="inventory" class="content-section">
                <div class="page-header">
                    <div class="page-header-content">
                        <h1>Controle de Estoque</h1>
                        <p>Gerenciamento completo de produtos e suprimentos</p>
                    </div>
                    <div class="page-header-actions">
                        <button class="btn btn-primary" id="add-product-btn"><i class="fas fa-plus"></i> Novo Produto</button>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-boxes"></i></div>
                        <div class="stat-info"><h3 id="total-products">0</h3><p>Total de Produtos</p></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-info"><h3 id="low-stock-products">0</h3><p>Estoque Baixo</p></div>
                    </div>
                </div>
                <div class="filters-container">
                    <div class="search-box"><i class="fas fa-search"></i><input type="text" id="product-search" placeholder="Buscar produtos..."></div>
                </div>
                <div class="table-container">
                    <table id="products-table">
                        <thead>
                            <tr><th>Imagem</th><th>Produto</th><th>Categoria</th><th>Marca</th><th>Animal</th><th>Estoque</th><th>Preço</th><th>Ações</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section id="reports" class="content-section">
                <div class="page-header">
                    <div class="page-header-content">
                        <h1>Relatórios</h1>
                        <p>Análises e estatísticas detalhadas</p>
                    </div>
                </div>
                <div class="reports-grid">
                    <div class="report-card">
                        <h3>Relatório Mensal</h3>
                        <select id="report-month"><option value="">Selecione o mês</option></select>
                        <button class="btn btn-secondary" id="generate-monthly-report"><i class="fas fa-file-pdf"></i> Gerar Relatório</button>
                    </div>
                </div>
                <div id="report-content" class="report-content"></div>
            </section>
        </div>
    </main>

    <!-- Modais -->
    <div id="animal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="animal-modal-title">Novo Animal</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="animal-form">
                <div class="form-group animal-photo-group">
                    <label>Identificação do Animal</label>
                    <div class="photo-selector-modern">
                        <div class="photo-preview-box" onclick="document.getElementById('animal-photo').click()">
                            <img id="photo-preview" src="" alt="Preview" style="display:none;">
                            <div class="photo-placeholder" id="photo-placeholder"><i class="fas fa-camera"></i><span>Adicionar Foto</span></div>
                        </div>
                        <div class="photo-actions-modern">
                            <input type="file" id="animal-photo" accept="image/*" hidden>
                            <button type="button" class="btn-icon-modern" id="start-camera-btn"><i class="fas fa-camera"></i></button>
                        </div>
                    </div>
                </div>
                <div class="form-group"><label>Nome *</label><input type="text" id="animal-name" required></div>
                <div class="form-group"><label>Tutor *</label><input type="text" id="tutor-name" required></div>
                <div class="form-group"><label>Telefone *</label><input type="tel" id="tutor-phone" required></div>
                <div class="form-group"><label>Espécie *</label><select id="animal-species" required><option value="CÃO">Cão</option><option value="GATO">Gato</option></select></div>
                <div class="form-actions"><button type="button" class="btn btn-secondary" id="cancel-animal">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div>
            </form>
        </div>
    </div>

    <div id="reservation-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="reservation-modal-title">Nova Reserva</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="reservation-form">
                <div class="form-row">
                    <div class="form-group"><label>Animal *</label><select id="reservation-animal" required></select></div>
                    <div class="form-group"><label>Alojamento *</label><select id="reservation-accommodation-type" required></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Número *</label><select id="reservation-kennel-number" required disabled></select></div>
                    <div class="form-group"><label>Diária *</label><input type="number" id="daily-rate" step="0.01" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Entrada *</label><input type="date" id="checkin-date" required></div>
                    <div class="form-group"><label>Saída *</label><input type="date" id="checkout-date" required></div>
                </div>
                <div class="services-selection">
                    <h4>Serviços Adicionais</h4>
                    <div class="services-grid-modern">
                        <label class="service-checkbox-card"><input type="checkbox" id="transport-service"><div class="service-card-content"><i class="fas fa-car"></i><span>Transporte</span><input type="number" id="transport-value" disabled class="mini-price-input"></div></label>
                        <label class="service-checkbox-card"><input type="checkbox" id="bath-service"><div class="service-card-content"><i class="fas fa-shower"></i><span>Banho</span><input type="number" id="bath-value" disabled class="mini-price-input"></div></label>
                        <label class="service-checkbox-card wa-service"><input type="checkbox" id="whatsapp-receipt"><div class="service-card-content"><i class="fab fa-whatsapp"></i><span>Recibo via WhatsApp</span></div></label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Pagamento *</label><select id="payment-method" required><option value="PIX">PIX</option><option value="CREDITO">Crédito</option></select></div>
                    <div class="form-group"><label>Total</label><input type="text" id="total-value" readonly></div>
                </div>
                <div class="form-actions"><button type="button" class="btn btn-secondary" id="cancel-reservation">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div>
            </form>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <div class="fab-container" id="fab-container">
        <div class="fab-menu" id="fab-menu">
            <button class="fab-item" onclick="window.reservationsManager.openReservationModal()">
                <i class="fas fa-calendar-check"></i><span>Reserva</span>
            </button>
            <button class="fab-item" onclick="window.animalsManager.openAnimalModal()">
                <i class="fas fa-dog"></i><span>Animal</span>
            </button>
        </div>
        <button class="fab-main" id="fab-main"><i class="fas fa-plus"></i></button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/storage-service.js"></script>
    <script src="js/database.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/animals.js"></script>
    <script src="js/reservations.js"></script>
    <script src="js/reports.js"></script>
    <script src="js/kennels.js"></script>
    <script src="js/inventory.js"></script>
    <script src="js/backup.js"></script>
    <script src="js/features.js"></script>
    <script src="js/app.js"></script>

    <script>
        function navigateToSection(sectionName) { if (window.hotelPetApp) window.hotelPetApp.navigateToSection(sectionName); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('active'); }
        function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.querySelector('.sidebar-overlay').classList.remove('active'); }

        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('loading').classList.add('fade-out');
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('app').classList.remove('hidden');
                    document.getElementById('app').classList.add('visible');
                }, 800);
            }, 1000);
        });

        // ===== PWA ROBUST UPDATE LOGIC =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/service-worker.js');
                    
                    // Se já existir um worker esperando (waiting), mostrar notificação
                    if (registration.waiting) {
                        showUpdateNotification(registration.waiting);
                    }

                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification(newWorker);
                            }
                        });
                    });
                } catch (err) {
                    console.error('SW registration failed:', err);
                }
            });

            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                refreshing = true;
                window.location.reload();
            });
        }

        function showUpdateNotification(worker) {
            // Evitar duplicatas
            if (document.querySelector('.update-notification')) return;

            const notification = document.createElement('div');
            notification.className = 'update-notification';
            notification.innerHTML = `
                <div class="update-content">
                    <i class="fas fa-sync-alt"></i>
                    <span>Nova versão disponível!</span>
                    <button id="update-app-btn">Atualizar</button>
                </div>
            `;
            document.body.appendChild(notification);
            
            document.getElementById('update-app-btn').onclick = () => {
                worker.postMessage({ type: 'SKIP_WAITING' });
            };
        }
    </script>
</body>
</html>